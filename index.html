<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
  <title>ระบบบันทึกและแชร์ Flex Message</title>
  
  <!-- Styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="flexhtml.css">
  <link rel="icon" href="https://th.bing.com/th/id/OIG4.QbUR8N98pPSmXzzUykuK?dpr=3&pid=ImgDetMain" type="image/x-icon">

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="flexhtml.js"></script>

  <style>
    :root {
      --primary-color: #00B900;
      --background-color: #fafafa;
      --preview-bg: #849ebf;
    }

    body {
      background-color: var(--background-color);
      font-family: system-ui, -apple-system, sans-serif;
    }

    .loader-container {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .loader {
      width: 160px;
      height: 100px;
      border-radius: 5px;
      background: #1e3f57;
      animation: dot1 3s cubic-bezier(0.55, 0.3, 0.24, 0.99) infinite;
      position: relative;
    }

    .loader::before {
      content: "Loading";
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 1.5rem;
    }

    /* Animations */
    @keyframes dot1 {
      3%, 97% { width: 160px; height: 100px; }
      30%, 36% { width: 80px; height: 120px; }
      63%, 69% { width: 40px; height: 80px; }
    }

    .line-bg {
      background-color: var(--primary-color);
    }

    .flex-preview {
      background-color: var(--preview-bg);
      background-image: url('./line bg.jpg');
      background-size: contain;
      border-radius: 8px;
      overflow: auto;
      padding: 1rem;
    }

    .section-hidden {
      display: none;
    }
  </style>
</head>

<body>
  <!-- Loader -->
  <section id="loader" class="loader-container">
    <div class="loader"></div>
  </section>

  <!-- Login Section -->
  <section id="login-sec" class="vh-100 d-flex justify-content-center align-items-center section-hidden">
    <div class="card shadow-sm p-4">
      <p class="text-center mb-4">กรุณา Login ด้วย Line เพื่อใช้งาน</p>
      <button class="btn line-bg text-white w-100" id="login-btn">
        <img src="https://img.icons8.com/fluency-systems-regular/48/ffffff/line-me.png" alt="Line" class="me-2" style="width: 24px;">
        Login
      </button>
    </div>
  </section>

  <!-- Main Content -->
  <section id="input-sec" class="py-5 section-hidden">
    <div class="container">
      <header class="mb-4">
        <h1 class="display-4">สวัสดี <span id="displayName"></span></h1>
        <img id="display-img" class="rounded-circle" style="width: 50px;" alt="Profile">
      </header>

      <div class="row g-4">
        <!-- Input Area -->
        <div class="col-md-7">
          <div class="card">
            <div class="card-body">
              <div class="mb-3">
                <label for="altText" class="form-label">ข้อความแสดงแทน FLEX <span id="text-count" class="text-muted">(0/400)</span></label>
                <input type="text" class="form-control" id="altText" maxlength="400">
              </div>

              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <label for="json" class="form-label">JSON</label>
                  <a href="https://developers.line.biz/flex-simulator/" target="_blank" class="btn btn-info">
                    <i class="bi bi-window-fullscreen"></i> ออกแบบ Flex
                  </a>
                </div>
                <textarea id="json" rows="15" class="form-control"></textarea>
              </div>

              <div class="d-grid gap-2 d-md-flex">
                <button id="save" class="btn btn-primary">
                  <i class="bi bi-floppy2-fill"></i> บันทึก
                </button>
                <button id="shared" class="btn btn-success">
                  <i class="bi bi-share-fill"></i> แชร์
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Preview Area -->
        <div class="col-md-5">
          <div id="flex-show" class="flex-preview">
            <div class="text-light text-center py-3">ตัวอย่าง Flex Message จะแสดงที่นี่</div>
          </div>
        </div>
      </div>

      <!-- Flex List -->
      <div id="flexlist" class="row g-3 mt-4"></div>
    </div>
  </section>

  <!-- Preview Modal -->
  <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="previewModalLabel">ตัวอย่าง Flex</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body flex-preview">
          <div id="flex1"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-info" id="json-copy">คัดลอก</button>
          <button type="button" class="btn btn-warning" id="json-update">อัปเดต</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import Swal from 'https://cdn.jsdelivr.net/npm/sweetalert2@11/+esm';

    const CONFIG = {
      LIFF_ID: '2005615503-JXQ1zqO3',
      SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzDrVrPPTbKHKTySkUHxwc2DclT8-tZvzRi8abRYyhDgT98YQTlpE9DsZ3jtNeg1xIO/exec',
      EXPIRE_USERS: [
        'U026ec80e42049561bd41cf92d4c55955',
        'U5fb67c286549e2eec9ff7f67e9c15690',
        'Ud2256fed03eacac0ed0d5d679ebdacde',
        'U0f88770ee60bc3b9ec52f9a95179d191',
        'Ue86787127a9bb5465c58d3932ed06bbb'
      ]
    };

    let profile, flexId;

    // Toast Configuration
    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 1500,
      timerProgressBar: true,
    });

    // Initialize LIFF
    async function initializeLiff() {
      await liff.init({ liffId: CONFIG.LIFF_ID, withLoginOnExternalBrowser: true });
      
      const startTime = Date.now();
      await liff.ready;
      
      const elapsed = Date.now() - startTime;
      if (elapsed < 3000) await new Promise(r => setTimeout(r, 3000 - elapsed));
      
      $('#loader').fadeOut(300);
      
      if (!liff.isLoggedIn()) {
        $('#login-sec').removeClass('section-hidden');
        $('#login-btn').on('click', () => liff.login({ redirectUri: window.location.href }));
        return;
      }

      await handleLoggedInState();
    }

    async function handleLoggedInState() {
      const userId = liff.getDecodedIDToken().sub;
      if (CONFIG.EXPIRE_USERS.includes(userId)) {
        await Swal.fire({
          icon: 'error',
          title: 'การทดลองใช้งานหมดอายุ',
          html: 'กรุณาติดต่อผู้พัฒนา<br>Line ID: <a href="https://line.me/ti/p/FrAUVjmBeJ">wmhakrook</a><br>Tel: <a href="tel:0904017402">090-401-7402</a>',
          allowOutsideClick: false,
          confirmButtonText: 'ปิด'
        });
        liff.closeWindow();
        return;
      }

      const params = new URLSearchParams(window.location.search);
      flexId = params.get('s');

      if (flexId) {
        await handleFlexShare();
      } else {
        await setupMainInterface();
      }
    }

    async function setupMainInterface() {
      $('#login-sec').addClass('section-hidden');
      $('#input-sec').removeClass('section-hidden').hide().slideDown(200);

      const context = await liff.getContext();
      profile = context.type === 'square_chat' 
        ? { displayName: 'openchat', userId: context.squareMemberId, isSquare: true }
        : await liff.getProfile();

      $('#displayName').text(profile.displayName);
      $('#display-img').attr('src', profile.pictureUrl);
      setupEventListeners();
      await fetchFlexList();
    }

    // Event Listeners
    function setupEventListeners() {
      $('#altText').on('input', function() {
        $('#text-count').text(`(${this.value.length}/400)`);
      });

      $('#json').on('input', function() {
        const json = parseJson(this.value);
        $('#flex-show').html(json 
          ? '' 
          : '<div class="text-light text-center py-3">JSON ไม่ถูกต้อง</div>');
        if (json) flex2html('flex-show', json);
      });

      $('#save').on('click', saveFlex);
      $('#shared').on('click', () => shareFlex(getFlexJson()));
    }

    function parseJson(text) {
      try {
        return JSON.parse(text);
      } catch {
        return null;
      }
    }

    function getFlexJson() {
      const json = parseJson($('#json').val());
      if (!json) {
        Swal.fire({ icon: 'error', title: 'JSON ไม่ถูกต้อง' });
        return null;
      }
      return json.type === 'flex' ? json : {
        type: 'flex',
        altText: $('#altText').val() || 'FLEX MESSAGE',
        contents: json
      };
    }

    async function saveFlex() {
      const flex = getFlexJson();
      if (!flex) return;

      const { value: templateName } = await Swal.fire({
        title: 'ตั้งชื่อ FLEX',
        input: 'text',
        showCancelButton: true,
        confirmButtonText: 'บันทึก'
      });

      if (!templateName) return;

      const response = await $.post(CONFIG.SCRIPT_URL, {
        q: 'put',
        isSquare: profile.isSquare,
        name: templateName,
        flex: JSON.stringify(flex),
        uid: profile.userId,
        liff_id: CONFIG.LIFF_ID
      });

      if (response.result === 'duplicate') {
        Toast.fire({ icon: 'warning', title: 'ชื่อซ้ำ' });
        return;
      }

      addFlexToList(response.data);
      Toast.fire({ icon: 'success', title: 'บันทึกสำเร็จ' });
    }

    async function shareFlex(flex) {
      if (!flex) return;
      if (JSON.stringify(flex).includes('{{share}}') && !flexId) {
        Swal.fire({ icon: 'error', title: 'กรุณาบันทึกก่อนแชร์เมื่อใช้ {{share}}' });
        return;
      }

      const result = await liff.shareTargetPicker([flex]);
      if (result) {
        Toast.fire({ icon: 'success', title: 'แชร์สำเร็จ' });
        if (flexId) liff.closeWindow();
      }
    }

    async function fetchFlexList() {
      $('#flexlist').LoadingOverlay('show');
      const response = await $.post(CONFIG.SCRIPT_URL, {
        q: 'get',
        isSquare: profile.isSquare,
        uid: profile.userId
      });
      $('#flexlist').LoadingOverlay('hide');

      if (response.status !== 200) return;

      $('#flexlist').empty();
      response.data.forEach(item => addFlexToList([item.flex_id, item.name, item.flex]));
    }

    function addFlexToList([id, name, flex]) {
      const $item = $(`
        <div class="col-md-4">
          <div class="btn-group w-100">
            <button class="btn btn-outline-info flex-name">${name}</button>
            <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown"></button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item shared-flex">แชร์</a></li>
              <li><a class="dropdown-item show-json">ดู JSON</a></li>
              <li><a class="dropdown-item share-link" data-link="https://liff.line.me/${CONFIG.LIFF_ID}?s=${id}">คัดลอกลิงก์</a></li>
              <li><a class="dropdown-item delete-list text-danger" data-id="${id}">ลบ</a></li>
            </ul>
          </div>
          <div class="flex-data" style="display: none;">${flex}</div>
        </div>
      `);
      $('#flexlist').append($item);
      setupFlexItemListeners($item);
    }

    function setupFlexItemListeners($item) {
      $item.find('.flex-name').on('click', function() {
        const flex = JSON.parse($item.find('.flex-data').text());
        $('#json').val(JSON.stringify(flex, null, 4)).trigger('input');
        $('#altText').val($(this).text());
      });

      $item.find('.shared-flex').on('click', () => {
        shareFlex(JSON.parse($item.find('.flex-data').text()));
      });

      $item.find('.share-link').on('click', async function() {
        await navigator.clipboard.writeText($(this).data('link'));
        Toast.fire({ icon: 'success', title: 'คัดลอกลิงก์สำเร็จ' });
      });

      $item.find('.delete-list').on('click', async function() {
        const id = $(this).data('id');
        const { isConfirmed } = await Swal.fire({
          title: 'ยืนยันการลบ?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'ลบ',
          cancelButtonText: 'ยกเลิก'
        });

        if (!isConfirmed) return;

        await $.post(CONFIG.SCRIPT_URL, { q: 'delete', id });
        $item.remove();
        Toast.fire({ icon: 'success', title: 'ลบสำเร็จ' });
      });
    }

    // Start application
    $(document).ready(() => initializeLiff());
  </script>
</body>
</html>
